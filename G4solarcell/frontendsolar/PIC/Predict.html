<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Fault Analyzer AI Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="overlay"></div>
    <div class="container">

        <div class="header">
            <img src="PIC/icon.avif" alt="Solar Panel Icon" class="logo">
            <div>
                <h1>Solar Fault Analyzer</h1>
                <h2>AI Dashboard for Real-time Sensor Diagnosis</h2>
            </div>
        </div>

        <div class="nav-bar">
            <a href="home.html" class="nav-link">Home</a>
            <a href="Predict.html" class="nav-link" style="color: #64FFDA; border-bottom: 2px solid #64FFDA;">AI Diagnostic
                Tool</a>
            <a href="Introduce.html" class="nav-link">Project Team</a>
        </div>

        <form id="sensorForm">
            <div class="input-form">
                <div class="input-group">
                    <label for="voltage">Voltage (V)</label>
                    <input type="number" id="voltage" step="any" value="16.0" required>
                </div>
                <div class="input-group">
                    <label for="temperature">Temperature (C)</label>
                    <input type="number" id="temperature" step="any" value="30.0" required>
                </div>
                <div class="input-group">
                    <label for="dust">Dust (ug/m3)</label>
                    <input type="number" id="dust" step="any" value="24.0" required>
                </div>
                <div class="input-group">
                    <label for="irradiance">Irradiance (lx)</label>
                    <input type="number" id="irradiance" step="any" value="5000.0" required>
                </div>
            </div>
            <button type="submit">RUN AI ANALYSIS</button>
        </form>

        <div id="result-box" class="status-warning">
            Awaiting Analysis...
        </div>

        <h2>Probability Breakdown</h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Problem Class</th>
                    <th style="width: 70%;">Probability Score</th>
                </tr>
            </thead>
            <tbody id="probabilityTable">
                <tr>
                    <td colspan="2" style="text-align: center;">Run analysis to see probabilities.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        const labelMap = {
            0: "ปกติ (Normal)", 1: "ฝุ่นหรือเงาบัง (Dust/Shade)", 2: "อุณหภูมิสูง (High Temp)", 3: "แรงดันไฟฟ้าตก (Low Voltage)", 4:"ค่าผิดปกติ (Sensor Error)"
        };
       
        document.getElementById('sensorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // ⚠️ การแก้ไข: เปลี่ยนจากการสร้าง array เป็นการสร้าง Object ที่มี key-value ตรงกับที่ Python คาดหวัง
            const payload = {
                voltage: parseFloat(document.getElementById('voltage').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                dust: parseFloat(document.getElementById('dust').value),
                irradiance: parseFloat(document.getElementById('irradiance').value)
            };

            const resultBox = document.getElementById('result-box');
            resultBox.innerText = "Analyzing...";
            resultBox.className = 'status-warning';
            resultBox.style.animation = 'none';

            try {
                const response = await fetch("https://g4weds.consolutechcloud.com/backend/predict", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // ⚠️ การแก้ไข: ส่ง Object payload โดยตรง
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // ⚠️ การแก้ไข: ดึงค่าจาก key 'result' ที่ Flask ส่งกลับ
                const predictedLabel = result.result;
                resultBox.innerText = `STATUS: ${predictedLabel}`;

                if (predictedLabel.includes('ปกติ')) {
                    resultBox.className = 'status-normal';
                } else if (predictedLabel.includes('ผิดปกติ')) {
                    resultBox.className = 'status-error';
                } else {
                    resultBox.className = 'status-warning';
                }
                
                resultBox.style.animation = 'pulse 1.5s infinite alternate';

                // ⚠️ การแก้ไข: ดึงค่าจาก key 'probabilities' ที่ Flask ส่งกลับ
                const probabilities = result.probabilities;
                const tableBody = document.getElementById('probabilityTable');
                tableBody.innerHTML = '';

                // probabilities เป็น Object เช่น {"0": 0.1, "1": 0.7, ...}
                Object.entries(probabilities).forEach(([index, prob]) => {
                    const row = tableBody.insertRow();
                    // index เป็น string ต้องแปลงเป็น Int เพื่อใช้กับ labelMap
                    const label = labelMap[parseInt(index)] || `Class ${index}`; 
                    const probPercent = (prob * 100).toFixed(2);

                    row.insertCell(0).innerText = label;

                    const probCell = row.insertCell(1);
                    probCell.innerHTML = `
                        ${probPercent}%
                        <div class="prob-bar-container">
                            <div class="prob-bar" style="width: ${probPercent}%;"></div>
                        </div>
                    `;
                });

            } catch (error) {
                resultBox.innerText = `ERROR: ${error.message}. Check Python API status.`;
                resultBox.className = 'status-error';
                resultBox.style.animation = 'none';
                console.error("Fetch error:", error);
            }
        });
    </script>
</body>

</html>